<Page x:Class="FileBoy.App.Pages.BrowserPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:vm="clr-namespace:FileBoy.App.ViewModels"
      xmlns:converters="clr-namespace:FileBoy.App.Converters"
      mc:Ignorable="d" 
      d:DesignHeight="600" d:DesignWidth="1000"
      Title="Browser"
      d:DataContext="{d:DesignInstance vm:MainViewModel}">
    
    <Page.Resources>
        <converters:ViewModeToVisibilityConverter x:Key="ViewModeToVisibility"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <converters:DoubleToGridLengthConverter x:Key="DoubleToGridLength"/>
    </Page.Resources>
    
    <Page.InputBindings>
        <KeyBinding Key="F5" Command="{Binding RefreshCommand}"/>
        <KeyBinding Key="Back" Command="{Binding GoUpCommand}"/>
        <KeyBinding Key="Backspace" Command="{Binding GoUpCommand}"/>
        <KeyBinding Modifiers="Alt" Key="Left" Command="{Binding GoBackCommand}"/>
        <KeyBinding Modifiers="Alt" Key="Right" Command="{Binding GoForwardCommand}"/>
        <KeyBinding Modifiers="Alt" Key="Up" Command="{Binding GoUpCommand}"/>
        <KeyBinding Modifiers="Ctrl" Key="OemComma" Command="{Binding OpenSettingsCommand}"/>
        <KeyBinding Modifiers="Ctrl" Key="X" Command="{Binding CutCommand}"/>
        <KeyBinding Modifiers="Ctrl" Key="C" Command="{Binding CopyCommand}"/>
        <KeyBinding Modifiers="Ctrl" Key="V" Command="{Binding PasteCommand}"/>
        <KeyBinding Key="Delete" Command="{Binding DeleteCommand}"/>
        <KeyBinding Modifiers="Ctrl+Shift" Key="N" Command="{Binding NewFolderCommand}"/>
    </Page.InputBindings>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Toolbar -->
        <ToolBar Grid.Row="0" Background="#f0f0f0" ToolBarTray.IsLocked="True">
            <Button Command="{Binding GoBackCommand}" ToolTip="Back (Alt+Left)" Padding="6,2">
                <TextBlock Text="←" FontSize="14"/>
            </Button>
            <Button Command="{Binding GoForwardCommand}" ToolTip="Forward (Alt+Right)" Padding="6,2">
                <TextBlock Text="→" FontSize="14"/>
            </Button>
            <Button Command="{Binding GoUpCommand}" ToolTip="Up (Alt+Up)" Padding="6,2">
                <TextBlock Text="↑" FontSize="14"/>
            </Button>
            <Separator/>
            <TextBox x:Name="PathBox" 
                     Text="{Binding CurrentPath, UpdateSourceTrigger=PropertyChanged}" 
                     Width="500" 
                     VerticalContentAlignment="Center"
                     KeyDown="PathBox_KeyDown"/>
            <Button Command="{Binding NavigateToPathCommand}" 
                    CommandParameter="{Binding Text, ElementName=PathBox}"
                    ToolTip="Go" Padding="6,2">
                <TextBlock Text="→" FontSize="14"/>
            </Button>
            <Separator/>
            <ToggleButton IsChecked="{Binding ViewMode, Converter={StaticResource ViewModeToVisibility}, ConverterParameter=List}"
                          Command="{Binding SetViewModeCommand}" 
                          CommandParameter="List"
                          ToolTip="List View" Padding="4,2">
                <TextBlock Text="☰" FontSize="14"/>
            </ToggleButton>
            <ToggleButton IsChecked="{Binding ViewMode, Converter={StaticResource ViewModeToVisibility}, ConverterParameter=Thumbnail}"
                          Command="{Binding SetViewModeCommand}" 
                          CommandParameter="Thumbnail"
                          ToolTip="Thumbnail View" Padding="4,2">
                <TextBlock Text="⊞" FontSize="14"/>
            </ToggleButton>
            <Separator/>
            <Button Command="{Binding OpenSettingsCommand}" ToolTip="Settings (Ctrl+,)" Padding="6,2">
                <TextBlock Text="⚙" FontSize="14"/>
            </Button>
        </ToolBar>
        
        <!-- Main Content Area with Preview Panel -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="PreviewColumn" Width="{Binding PreviewPanelWidth, Mode=OneWay, Converter={StaticResource DoubleToGridLength}}" MinWidth="30"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="150"/>
            </Grid.ColumnDefinitions>
            
            <!-- Image Preview Panel -->
            <Border Grid.Column="0" Background="#1e1e1e" BorderBrush="#333" BorderThickness="0,0,1,0">
                <Grid>
                    <!-- Preview when image is selected -->
                    <Image Source="{Binding PreviewImage}" 
                           Stretch="Uniform" 
                           Margin="10"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           RenderOptions.BitmapScalingMode="HighQuality"/>
                    <!-- Placeholder when no preview -->
                    <TextBlock Text="Select an image to preview" 
                               Foreground="#666"
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center"
                               FontSize="14"
                               Visibility="{Binding PreviewImage, Converter={StaticResource NullToVisibility}}"/>
                </Grid>
            </Border>
            
            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1" 
                          Width="5" 
                          HorizontalAlignment="Center" 
                          VerticalAlignment="Stretch"
                          Background="#CCCCCC"
                          Cursor="SizeWE"
                          DragCompleted="GridSplitter_DragCompleted"/>
            
            <!-- File Browser Area -->
            <Grid Grid.Column="2">
                <!-- Loading Overlay -->
                <Border Background="#80FFFFFF" 
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}"
                        Panel.ZIndex="100">
                    <TextBlock Text="Loading..." 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center"
                               FontSize="16"/>
                </Border>
                
                <!-- List View (DataGrid) -->
            <DataGrid x:Name="FileListGrid"
                      ItemsSource="{Binding Items}"
                      SelectedItem="{Binding SelectedItem}"
                      SelectionChanged="FileListGrid_SelectionChanged"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Extended"
                      GridLinesVisibility="None"
                      HeadersVisibility="Column"
                      RowHeaderWidth="0"
                      BorderThickness="0"
                      Background="White"
                      RowBackground="White"
                      AlternatingRowBackground="#FAFAFA"
                      Visibility="{Binding ViewMode, Converter={StaticResource ViewModeToVisibility}, ConverterParameter=List}"
                      MouseDoubleClick="FileListGrid_MouseDoubleClick">
                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="New Folder" Command="{Binding NewFolderCommand}" InputGestureText="Ctrl+Shift+N"/>
                        <Separator/>
                        <MenuItem Header="Cut" Command="{Binding CutCommand}" InputGestureText="Ctrl+X"/>
                        <MenuItem Header="Copy" Command="{Binding CopyCommand}" InputGestureText="Ctrl+C"/>
                        <MenuItem Header="Paste" Command="{Binding PasteCommand}" InputGestureText="Ctrl+V"/>
                        <Separator/>
                        <MenuItem Header="Delete" Command="{Binding DeleteCommand}" InputGestureText="Del"/>
                        <Separator/>
                        <MenuItem Header="Copy Full Path" Command="{Binding CopyFullPathCommand}"/>
                        <Separator/>
                        <MenuItem Header="Open" Command="{Binding OpenSelectedItemCommand}"/>
                    </ContextMenu>
                </DataGrid.ContextMenu>
                <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Name" Width="*" MinWidth="200">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="4,2">
                                    <TextBlock Text="{Binding IconGlyph}" FontSize="16" Margin="0,0,6,0" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="Size" Binding="{Binding FormattedSize}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="TextAlignment" Value="Right"/>
                                <Setter Property="Margin" Value="4,0"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Type" Binding="{Binding TypeDescription}" Width="180"/>
                    <DataGridTextColumn Header="Date Modified" Binding="{Binding ModifiedDate, StringFormat='{}{0:dd.MM.yyyy HH:mm}'}" Width="130"/>
                </DataGrid.Columns>
            </DataGrid>
            
            <!-- Thumbnail View -->
            <ListBox x:Name="ThumbnailList"
                     ItemsSource="{Binding Items}"
                     SelectedItem="{Binding SelectedItem}"
                     SelectionChanged="ThumbnailList_SelectionChanged"
                     SelectionMode="Extended"
                     Background="White"
                     BorderThickness="0"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     Visibility="{Binding ViewMode, Converter={StaticResource ViewModeToVisibility}, ConverterParameter=Thumbnail}"
                     MouseDoubleClick="ThumbnailList_MouseDoubleClick">
                <ListBox.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="New Folder" Command="{Binding NewFolderCommand}" InputGestureText="Ctrl+Shift+N"/>
                        <Separator/>
                        <MenuItem Header="Cut" Command="{Binding CutCommand}" InputGestureText="Ctrl+X"/>
                        <MenuItem Header="Copy" Command="{Binding CopyCommand}" InputGestureText="Ctrl+C"/>
                        <MenuItem Header="Paste" Command="{Binding PasteCommand}" InputGestureText="Ctrl+V"/>
                        <Separator/>
                        <MenuItem Header="Delete" Command="{Binding DeleteCommand}" InputGestureText="Del"/>
                        <Separator/>
                        <MenuItem Header="Copy Full Path" Command="{Binding CopyFullPathCommand}"/>
                        <Separator/>
                        <MenuItem Header="Open" Command="{Binding OpenSelectedItemCommand}"/>
                    </ContextMenu>
                </ListBox.ContextMenu>
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Width="{Binding DataContext.ThumbnailContainerSize, RelativeSource={RelativeSource AncestorType=ListBox}}" Margin="4">
                            <Border Width="{Binding DataContext.ThumbnailDisplaySize, RelativeSource={RelativeSource AncestorType=ListBox}}" 
                                    Height="{Binding DataContext.ThumbnailDisplaySize, RelativeSource={RelativeSource AncestorType=ListBox}}" 
                                    Background="#F5F5F5" 
                                    BorderBrush="#DDD" 
                                    BorderThickness="1"
                                    CornerRadius="4">
                                <Grid>
                                    <!-- Show thumbnail if available -->
                                    <Image Source="{Binding Thumbnail}" 
                                           Stretch="Uniform"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                                    <!-- Show icon if no thumbnail -->
                                    <TextBlock Text="{Binding IconGlyph}" 
                                               FontSize="48" 
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"
                                               Visibility="{Binding Thumbnail, Converter={StaticResource NullToVisibility}}"/>
                                </Grid>
                            </Border>
                            <TextBlock Text="{Binding Name}" 
                                       TextTrimming="CharacterEllipsis"
                                       TextAlignment="Center"
                                       Margin="0,4,0,0"
                                       FontSize="11"
                                       ToolTip="{Binding Name}"/>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            </Grid>
        </Grid>
        
        <!-- Status Bar -->
        <StatusBar Grid.Row="2" Background="#f0f0f0">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Page>
